# 重复文件清理功能使用说明

## 功能概述

SiYuan Optimizer 现已支持通过 filetreeAPI 清理指定文件夹下的重复文件（递归），此功能按照思源源代码的 API 参数和返回值结构实现。

## 功能特性

### 重复检测方式
- **文件名检测**: 基于文件名称（忽略大小写）检测重复
- **文件内容检测**: 基于文件内容比较检测重复  
- **文件哈希检测**: 基于文件内容哈希值检测重复

### 保留策略
- **最新文件**: 保留修改时间最新的文件
- **最旧文件**: 保留修改时间最早的文件
- **最大文件**: 保留文件大小最大的文件
- **最小文件**: 保留文件大小最小的文件

### 扫描选项
- **递归扫描**: 支持递归扫描子文件夹
- **文件大小过滤**: 可设置最小文件大小阈值
- **扩展名过滤**: 可忽略指定扩展名的文件
- **删除前确认**: 可选择是否在删除前弹出确认对话框

## 使用方法

### 1. 打开文件清理界面

**方式一：快捷键**
- 按 `Shift+Cmd+C` (macOS) 或 `Shift+Ctrl+C` (Windows/Linux)

**方式二：菜单**
1. 点击顶栏的优化器图标
2. 选择"清理重复文件"

### 2. 配置扫描参数

1. **选择笔记本**: 从下拉列表中选择要扫描的笔记本
2. **输入文件夹路径**: 指定要扫描的文件夹路径（如 `/` 表示整个笔记本）
3. **选择重复检测类型**: 
   - 文件名：只比较文件名
   - 文件内容：比较文件实际内容
   - 文件哈希：基于内容计算哈希值比较
4. **选择保留策略**: 当发现重复文件时，保留哪一个文件
5. **配置其他选项**:
   - 勾选"递归子文件夹"以扫描所有子目录
   - 勾选"删除前确认"以在删除时显示确认对话框

### 3. 执行扫描

1. 点击"扫描重复文件"按钮
2. 等待扫描完成
3. 查看扫描结果，包括：
   - 重复文件组数量
   - 总文件数
   - 可删除的重复文件数量

### 4. 清理重复文件

**批量清理：**
- 点击"清理所有重复文件"按钮，一次性清理所有重复文件

**分组清理：**
- 在每个重复文件组中，点击"清理此组"按钮

**单文件操作：**
- 点击"预览"查看文件内容
- 点击"删除"删除单个文件

## API 集成

### 核心 API 使用

```typescript
import { DuplicateFileCleaner, CleanupOptions } from './duplicate-cleaner';

// 创建清理器实例
const cleaner = new DuplicateFileCleaner();
await cleaner.initialize();

// 配置清理选项
const options: CleanupOptions = {
    duplicateType: 'content',    // 'name' | 'content' | 'hash'
    keepStrategy: 'newest',      // 'newest' | 'oldest' | 'largest' | 'smallest'
    recursive: true,             // 是否递归
    minFileSize: 1024,          // 最小文件大小（字节）
    ignoreExtensions: ['tmp'],   // 忽略的扩展名
    confirmBeforeDelete: true    // 删除前确认
};

// 扫描重复文件
const duplicateGroups = await cleaner.scanDuplicateFiles(
    'notebookId', 
    '/path/to/folder', 
    options
);

// 清理重复文件
const deletedCount = await cleaner.cleanupDuplicateFiles(
    duplicateGroups, 
    options
);
```

### 与思源 API 的集成

本功能使用了以下思源 API：

1. **`/api/notebook/lsNotebooks`**: 获取笔记本列表
2. **`/api/filetree/listDocsByPath`**: 列出指定路径下的文档
3. **`/api/file/readDir`**: 读取文件夹内容
4. **`/api/file/removeFile`**: 删除文件
5. **`/api/export/exportMdContent`**: 导出文档内容

## 安全特性

1. **确认机制**: 支持删除前确认，避免误删
2. **错误处理**: 完善的错误处理和用户提示
3. **原子操作**: 确保操作的原子性，避免部分失败
4. **日志记录**: 详细的操作日志，便于问题排查

## 注意事项

1. **备份重要数据**: 在进行大规模清理前，建议先备份重要数据
2. **测试小范围**: 建议先在小范围文件夹中测试功能
3. **网络连接**: 确保思源笔记运行正常，API 可正常访问
4. **权限检查**: 确保有足够权限删除目标文件
5. **性能考虑**: 大文件夹扫描可能需要较长时间，请耐心等待

## 故障排除

### 常见问题

1. **扫描失败**
   - 检查笔记本是否存在且已打开
   - 检查文件夹路径是否正确
   - 检查网络连接和 API 访问权限

2. **删除失败**
   - 检查文件是否被其他程序占用
   - 检查文件权限设置
   - 尝试手动删除确认权限

3. **性能问题**
   - 减小扫描范围
   - 增加最小文件大小限制
   - 避免在系统高负载时运行

### 调试信息

开发者可通过浏览器控制台查看详细的调试信息：
- 扫描进度
- API 调用详情  
- 错误堆栈信息

## 更新日志

### v1.1.0
- 新增重复文件清理功能
- 支持三种重复检测方式
- 支持四种文件保留策略
- 集成思源 filetreeAPI
- 添加完整的用户界面

---

如有问题或建议，请在 GitHub 仓库提交 Issue 或 Pull Request。
